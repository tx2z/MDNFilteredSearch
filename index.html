<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        
        <style> 
            *{
                box-sizing: border-box;
                -moz-box-sizing: border-box;
            }
        </style>
        
        
        <style>
            .q {
                border: 1px black dotted;
                padding: 3px;
                border-radius: 5px;
            }

            .filters {
                display: inline;
            }

            .filters span.topic{
                display: inline;
                border: 2px violet dashed;
                margin: 0 0.1em;
            }

            .filters span.topic button.close{
                width: 30px;
                height: 30px;
            }

            .q input{
                display: inline;
            }
            
            .search .suggestions{
                width: 600px;
                height: 200px;
                
                border: 1px violet dotted;
            }
        </style>
        
        <script src="http://code.jquery.com/jquery-2.1.0.js"> </script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function listener(){
                "use strict";
                
                // https://developer.mozilla.org/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html
                var BASE_SEARCH_URL = 'https://developer.mozilla.org/en-US/search.json';
                
                
                // prepare filter data
                var filtersDataEl = document.getElementById('filters-data');
                if(!filtersDataEl){
                    console.error('Element with filter data (#filters-data) not present in the page');
                    return; // just a fail-safe 
                }
                
                var filtersData = JSON.parse(filtersDataEl.textContent);
                
                
                /*var xhr = new XMLHttpRequest();
                xhr.open('GET', SEARCH_URL);
                
                xhr.addEventListener('load', function(e){
                    console.log(xhr.responseText);
                });
                
                xhr.addEventListener('error', function(e){
                    console.error(xhr.responseText);
                });
                
                xhr.send();*/

                function parse(s){
                    var matches = s.match(/^(#\S+)\s+|\s(#\S+)\s+/);
                    return matches ? matches[1] || matches[2] : matches;
                }
                
                
                var search = $('.q');
                var searchFilters = search.find('.filters');
                var searchInput = search.find('input')
                
                var previousValue = searchInput.val(); // it happens that the content is kept across refreshes
                
                // f is a topic with the # ('#javascript', '#advanced')
                function addFilter(f){
                    var filter = $('<span></span>')
                        .addClass('topic')
                        .attr('data-topic', f.slice('#'.length))
                        .text(f)
                        .appendTo(searchFilters);

                    $('<button></button>')
                        .addClass('close')
                        .text('x')
                        .on('click', function(){
                            $(filter).remove();
                        })
                        .appendTo(filter);
                }
                
                function parseAndAddFilters(){
                    var toParse = searchInput.val();
                    var filter = true;
                    var filters = [];
                    while(filter){
                        filter = parse(toParse);
                        if(filter){
                            filters.push(filter);
                            toParse = toParse.replace(filter, '').trim();
                        }
                    }
                    
                    if(filters.length >= 1){
                        filters.forEach(addFilter);
                        $('form.search .suggestions').attr('hidden', 'hidden');
                    }
                    
                    searchInput.val(toParse);
                }
                
                // Open Q : other events than input?
                searchInput.on('input', function(e){
                    
                    parseAndAddFilters();
                    
                    // find out if there is a difference of exactly one # between input.value and previousValue
                    // Current algorithm is very simple. Must be improved in the future
                    // Currently consider only the last character
                    if(searchInput.val().length - previousValue.length === 1 &&
                       searchInput.val()[searchInput.val().length -1] === '#')
                    {
                        console.log('show');
                        $('form.search .suggestions').removeAttr('hidden');
                    }
                    
                    if(previousValue.length - searchInput.val().length === 1 &&
                       previousValue[previousValue.length -1] === '#')
                    {
                        $('form.search .suggestions').attr('hidden', 'hidden');
                    }
                    
                    previousValue = searchInput.val();
                });
                
                $('form.search').on('submit', function(e){
                    e.preventDefault();
                    
                    var topics = $.makeArray($('form.search .topic')).map(function(e){
                        return encodeURIComponent($(e).attr('data-topic'));
                    });
                    var topicsString = topics
                        .map(function(t){ return 'topic='+t; })
                        .join('&');
                    
                    var q = encodeURIComponent(searchInput.val());
                    
                    var searchURL = BASE_SEARCH_URL + '?' +
                        'q=' + q +
                        '&' + topicsString;
                    
                    console.log('search URL', searchURL);
                })
                
                document.removeEventListener('DOMContentLoaded', listener);
            });
        </script>
        
        <script id="filters-data" type="application/json">
            [{"name": "Topics", "options": [{"name": "APIs and DOM", "slug": "api", "count": 613, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=api", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Add-ons & Extensions", "slug": "addons", "count": 168, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=addons", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "CSS", "slug": "css", "count": 349, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=css", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Canvas", "slug": "canvas", "count": 31, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=canvas", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Firefox", "slug": "firefox", "count": 64, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=firefox", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Firefox OS", "slug": "firefox-os", "count": 130, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=firefox-os", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Firefox for Android", "slug": "firefox-mobile", "count": 0, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=firefox-mobile", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Firefox for Desktop", "slug": "firefox-desktop", "count": 0, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=firefox-desktop", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Games", "slug": "games", "count": 7, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=games", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "HTML", "slug": "html", "count": 342, "active": true, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript"}}, {"name": "JavaScript", "slug": "js", "count": 368, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=js", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Marketplace", "slug": "marketplace", "count": 0, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=marketplace", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "MathML", "slug": "mathml", "count": 51, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=mathml", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Mobile", "slug": "mobile", "count": 42, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=mobile", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Open Web Apps", "slug": "apps", "count": 93, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=apps", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "SVG", "slug": "svg", "count": 97, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=svg", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Web Development", "slug": "webdev", "count": 67, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=webdev", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "WebGL", "slug": "webgl", "count": 14, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=webgl", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "XUL", "slug": "xul", "count": 118, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=xul", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}]}, {"name": "Document type", "options": [{"name": "Code Samples", "slug": "code", "count": 38, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=code", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "How-To & Tutorial", "slug": "howto", "count": 236, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=howto", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Tools", "slug": "tools", "count": 31, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=tools", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}]}, {"name": "Skill level", "options": [{"name": "I'm Learning", "slug": "beginner", "count": 17, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=beginner", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "I'm an Expert", "slug": "advanced", "count": 30, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=advanced", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}, {"name": "Intermediate", "slug": "intermediate", "count": 21, "active": false, "urls": {"active": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html&topic=intermediate", "inactive": "/en-US/search.json?q=html5&per_page=100&topic=javascript&topic=html"}}]}]
        </script>
        
        
        <title> TITLE </title>    
    </head>
    
    <body>
        <!--
        <form action="/" method="get">
            <input name="lol">
            <input name="lol">
            <input name="lol">
            <button type="submit">go</button>            
        </form>
        -->
        <form class="search">
            <div class="q">
                <div class="filters"></div>
                <input type="text" name="q">
            </div>
            <ul class="suggestions" hidden> 
            </ul>
        </form>
        
        
    </body>
</html>
